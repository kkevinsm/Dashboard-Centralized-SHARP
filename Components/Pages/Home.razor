@page "/"
@rendermode InteractiveServer
@using CentralizedDashboard.Models
@using CentralizedDashboard.Services
@inject MesinService ServiceKita 
@* ^ Memanggil service MySQL *@

<PageTitle>Monitoring Dashboard</PageTitle>

<div class="container-fluid mt-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="text-primary fw-bold">🏭 Centralized Monitoring System</h1>
            <p class="text-muted mb-0">Live Monitoring from PLC Mitsubishi FX5U</p>
        </div>
        <div class="text-end">
            <span class="badge bg-primary p-2 fs-6 me-2">
                Shift: <strong>@currentShift</strong>
            </span>
            <span class="badge bg-light text-dark border p-2 fs-6">
                🕒 @DateTime.Now.ToString("HH:mm:ss")
            </span>
        </div>
    </div>

    @if (logs == null)
    {
        <div class="alert alert-info">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            Menghubungkan ke Database...
        </div>
    }
    else
    {
        <div class="row g-3">
            @foreach (var mesin in mesinList)
            {
                var data = logs.FirstOrDefault(x => x.nama_mesin_proses == mesin);
                
                // Cek apakah data masih fresh (diupdate dalam 5 detik terakhir)
                var isDataFresh = false;
                if (data != null)
                {
                    var timeDifference = DateTime.Now - data.waktu;
                    isDataFresh = timeDifference.TotalSeconds <= 5;
                }
                
                // Jika data tidak fresh (error sudah teratasi), reset timer ke 0
                var timer = (data?.data_timer ?? 0);
                if (!isDataFresh)
                {
                    timer = 0; // Reset timer ketika error teratasi
                }
                
                // Mesin dianggap error HANYA jika timer > 0 DAN data fresh (update dalam 5 detik)
                var isError = timer > 0 && isDataFresh;
                
                <div class="col-12 col-sm-6 col-md-4 col-lg-3 col-xl-2">
                    <div class="card h-100 shadow-sm border-0 @(isError ? "border-danger border-2" : "")">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title fw-bold text-dark mb-0" style="font-size: 0.85rem; line-height: 1.3;">
                                    @mesin
                                </h6>
                                @if (isError)
                                {
                                    <span class="badge bg-danger">⚠️</span>
                                }
                                else
                                {
                                    <span class="badge bg-success">✓</span>
                                }
                            </div>
                            
                            <div class="mt-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Timer:</small>
                                    <span class="badge @(isError ? "bg-danger" : "bg-secondary") font-monospace">
                                        @FormatTimer(timer)
                                    </span>
                                </div>
                            </div>
                            
                            <div class="mt-2">
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar @(isError ? "bg-danger" : "bg-success")" 
                                         role="progressbar" 
                                         style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
    .card {
        transition: all 0.3s ease;
        border-radius: 8px;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
    }
    
    .card.border-danger {
        animation: pulse-border 2s infinite;
    }
    
    @@keyframes pulse-border {
        0%, 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
        50% { box-shadow: 0 0 0 4px rgba(220, 53, 69, 0.2); }
    }
</style>

@code {
    private List<ErrorLog>? logs;
    private System.Threading.Timer? timer;
    private string currentShift = "S1";
    
    // Daftar nama mesin tanpa prefix shift (24 item) - sesuai dengan database
    private List<string> mesinNames = new List<string>
    {
        "Auto Bellow Error",
        "Base To Tub Stop",
        "Flange Screw Stop",
        "Wiring Stop",
        "180 Turn Machine Error",
        "Half Transfer Error",
        "Visual Instructural Stop",
        "Fa Stop",
        "Feed Water Stop",
        "Inspection Room Stop",
        "Back Cover Stop",
        "Waranty Stop",
        "Auto Water Error",
        "I/W Test Error",
        "Washing Perform Test Error",
        "Dehydration Test Error",
        "Bottom Pad Stop",
        "Packing Stop",
        "Finish Packing Stop",
        "Transfer Packing Error",
        "Auto Folding Error",
        "Straping #1 Error",
        "Straping #2 Error",
        "Lifter Error"
    };
    
    // Generate mesinList dengan prefix shift yang aktif
    private List<string> mesinList => mesinNames.Select(name => $"{currentShift} - {name}").ToList();

    protected override void OnInitialized()
    {
        LoadData();

        timer = new System.Threading.Timer(async _ =>
        {
            LoadData();
            await InvokeAsync(StateHasChanged);
        }, null, 0, 1000); // Update setiap 1 detik
    }

    private void LoadData()
    {
        logs = ServiceKita.GetLatestLogs();
        
        // Deteksi shift otomatis dari data database (ambil shift dari record pertama yang ada)
        if (logs != null && logs.Any())
        {
            var firstLog = logs.FirstOrDefault();
            if (firstLog != null && !string.IsNullOrEmpty(firstLog.nama_mesin_proses))
            {
                // Extract shift dari nama mesin (format: "S1 - NAMA MESIN")
                var parts = firstLog.nama_mesin_proses.Split('-');
                if (parts.Length > 0)
                {
                    var shiftPart = parts[0].Trim();
                    if (shiftPart.StartsWith("S") && (shiftPart == "S1" || shiftPart == "S2" || shiftPart == "S3"))
                    {
                        currentShift = shiftPart;
                    }
                }
            }
        }
        
        // ATAU deteksi shift berdasarkan jam (opsional, uncomment jika ingin pakai)
        // currentShift = GetShiftByTime();
    }
    
    // Method untuk deteksi shift berdasarkan jam
    private string GetShiftByTime()
    {
        var now = DateTime.Now;
        var hour = now.Hour;
        var minute = now.Minute;
        
        // Pembagian shift perusahaan:
        // S1: 07:56 - 17:00
        // S2: 17:01 - 00:25
        // S3: 00:26 - 07:55
        
        // S1: 07:56 - 17:00
        if ((hour == 7 && minute >= 56) || (hour > 7 && hour < 17) || (hour == 17 && minute == 0))
        {
            return "S1";
        }
        // S2: 17:01 - 00:25
        else if ((hour == 17 && minute >= 1) || (hour > 17 && hour <= 23) || (hour == 0 && minute <= 25))
        {
            return "S2";
        }
        // S3: 00:26 - 07:55
        else
        {
            return "S3";
        }
    }
    
    // Method untuk format timer dari detik ke jam/menit/detik
    private string FormatTimer(int seconds)
    {
        if (seconds >= 3600) // >= 1 jam
        {
            int hours = seconds / 3600;
            int minutes = (seconds % 3600) / 60;
            int secs = seconds % 60;
            
            if (minutes > 0 && secs > 0)
                return $"{hours}h {minutes}m {secs}s";
            else if (minutes > 0)
                return $"{hours}h {minutes}m";
            else
                return $"{hours}h";
        }
        else if (seconds >= 60) // >= 1 menit
        {
            int minutes = seconds / 60;
            int secs = seconds % 60;
            
            if (secs > 0)
                return $"{minutes}m {secs}s";
            else
                return $"{minutes}m";
        }
        else // < 1 menit
        {
            return $"{seconds}s";
        }
    }

    public void Dispose()
    {
        timer?.Dispose();
    }
}