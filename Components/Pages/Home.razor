@page "/"
@rendermode InteractiveServer
@using CentralizedDashboard.Models
@using CentralizedDashboard.Services
@inject MesinService ServiceKita 
@* ^ Memanggil service MySQL *@

<PageTitle>Monitoring Dashboard</PageTitle>

<div class="container-fluid mt-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="text-primary fw-bold">🏭 Centralized Monitoring System</h1>
            <p class="text-muted mb-0">Live Monitoring from PLC Mitsubishi FX5U</p>
        </div>
        <div class="text-end">
            <span class="badge bg-primary p-2 fs-6 me-2">
                Shift: <strong>@currentShift</strong>
            </span>
            <span class="badge bg-light text-dark border p-2 fs-6">
                🕒 @DateTime.Now.ToString("HH:mm:ss")
            </span>
        </div>
    </div>

    @if (logs == null)
    {
        <div class="alert alert-info">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            Menghubungkan ke Database...
        </div>
    }
    else
    {
        <div class="row g-3">
            @foreach (var mesin in mesinList)
            {
                var data = logs.FirstOrDefault(x => x.nama_mesin_proses == mesin);
                var timer = data?.data_timer ?? 0;
                var isError = timer > 0;
                
                <div class="col-12 col-sm-6 col-md-4 col-lg-3 col-xl-2">
                    <div class="card h-100 shadow-sm border-0 @(isError ? "border-danger border-2" : "")">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title fw-bold text-dark mb-0" style="font-size: 0.85rem; line-height: 1.3;">
                                    @mesin
                                </h6>
                                @if (isError)
                                {
                                    <span class="badge bg-danger">⚠️</span>
                                }
                                else
                                {
                                    <span class="badge bg-success">✓</span>
                                }
                            </div>
                            
                            <div class="mt-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Timer:</small>
                                    <span class="badge @(isError ? "bg-danger" : "bg-secondary") font-monospace">
                                        @timer s
                                    </span>
                                </div>
                            </div>
                            
                            <div class="mt-2">
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar @(isError ? "bg-danger" : "bg-success")" 
                                         role="progressbar" 
                                         style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
    .card {
        transition: all 0.3s ease;
        border-radius: 8px;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
    }
    
    .card.border-danger {
        animation: pulse-border 2s infinite;
    }
    
    @@keyframes pulse-border {
        0%, 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
        50% { box-shadow: 0 0 0 4px rgba(220, 53, 69, 0.2); }
    }
</style>

@code {
    private List<ErrorLog>? logs;
    private System.Threading.Timer? timer;
    private string currentShift = "S1";
    
    // Daftar nama mesin tanpa prefix shift (25 item)
    private List<string> mesinNames = new List<string>
    {
        "AUTO BELLOW ERROR",
        "BASE TO TUB STOP",
        "FLANGE SCREW STOP",
        "WIRING STOP",
        "180 TURN MACHINE ERROR",
        "HALF TRANSFER ERROR",
        "VISUAL INSTRUCTURAL STOP",
        "FA STOP",
        "FEED WATER STOP",
        "INSPECTION ROOM STOP",
        "BACK COVER STOP",
        "WARANTY STOP",
        "AUTO WATER ERROR",
        "I/W TESTERROR",
        "WASHING PERFORM TEST ERROR",
        "DEHYDRATION TEST ERROR",
        "BOTTOM PAD STOP",
        "PACKING STOP",
        "FINISH PACKING STOP",
        "TRANSFER PACKING ERROR",
        "AUTO FOLDING ERROR",
        "STRAPING #1 ERROR",
        "STRAPING #2 ERROR",
        "LIFTER ERROR"
    };
    
    // Generate mesinList dengan prefix shift yang aktif
    private List<string> mesinList => mesinNames.Select(name => $"{currentShift} - {name}").ToList();

    protected override void OnInitialized()
    {
        LoadData();

        timer = new System.Threading.Timer(async _ =>
        {
            LoadData();
            await InvokeAsync(StateHasChanged);
        }, null, 0, 1000); // Update setiap 1 detik
    }

    private void LoadData()
    {
        logs = ServiceKita.GetLatestLogs();
        
        // Deteksi shift otomatis dari data database (ambil shift dari record pertama yang ada)
        if (logs != null && logs.Any())
        {
            var firstLog = logs.FirstOrDefault();
            if (firstLog != null && !string.IsNullOrEmpty(firstLog.nama_mesin_proses))
            {
                // Extract shift dari nama mesin (format: "S1 - NAMA MESIN")
                var parts = firstLog.nama_mesin_proses.Split('-');
                if (parts.Length > 0)
                {
                    var shiftPart = parts[0].Trim();
                    if (shiftPart.StartsWith("S") && (shiftPart == "S1" || shiftPart == "S2" || shiftPart == "S3"))
                    {
                        currentShift = shiftPart;
                    }
                }
            }
        }
        
        // ATAU deteksi shift berdasarkan jam (opsional, uncomment jika ingin pakai)
        // currentShift = GetShiftByTime();
    }
    
    // Method untuk deteksi shift berdasarkan jam (opsional)
    private string GetShiftByTime()
    {
        var hour = DateTime.Now.Hour;
        
        // Contoh pembagian shift (sesuaikan dengan aturan perusahaan):
        // S1: 07:00 - 15:00
        // S2: 15:00 - 23:00
        // S3: 23:00 - 07:00
        
        if (hour >= 7 && hour < 15)
            return "S1";
        else if (hour >= 15 && hour < 23)
            return "S2";
        else
            return "S3";
    }

    public void Dispose()
    {
        timer?.Dispose();
    }
}