@page "/"
@rendermode InteractiveServer
@using CentralizedDashboard.Models
@using CentralizedDashboard.Services
@inject MesinService ServiceKita 

<PageTitle>Monitoring Dashboard</PageTitle>

<link rel="stylesheet" href="home-responsive.css" />
<link rel="stylesheet" href="dashboard-carousel.css" />

<!-- Carousel Navigation -->
<button class="carousel-nav prev" @onclick="PreviousPage" disabled="@(currentPage == 0)">
    ‹
</button>
<button class="carousel-nav next" @onclick="NextPage" disabled="@(currentPage == 2)">
    ›
</button>

<!-- Page Indicators -->
<div class="carousel-indicators @(sidebarExpanded ? "sidebar-expanded" : "")">
    <div class="carousel-indicator @(currentPage == 0 ? "active" : "")" @onclick="() => GoToPage(0)"></div>
    <div class="carousel-indicator @(currentPage == 1 ? "active" : "")" @onclick="() => GoToPage(1)"></div>
    <div class="carousel-indicator @(currentPage == 2 ? "active" : "")" @onclick="() => GoToPage(2)"></div>
</div>

<div class="dashboard-carousel @(sidebarExpanded ? "sidebar-expanded" : "")">
    <div class="carousel-container" style="transform: translateX(-@(currentPage * 33.333)%);">
        
        <!-- PAGE 1: Card Dashboard -->
        <div class="carousel-page">
            <div class="container-fluid mt-3 position-relative" style="min-height: 100vh;">
                <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h1 class="text-primary fw-bold mb-0">CENTRALIZED</h1>
            <h1 class="text-primary fw-bold">MONITORING SYSTEM</h1>
            <p class="text-muted mb-0" style="font-size: 1.4rem;">WASHING MACHINE DIVISION</p>
        </div>
        <div class="text-end">
            <div class="d-inline-block">
                <div class="mb-1 d-flex align-items-center">
                    <span class="badge bg-primary p-2 fs-6 me-2">
                        Shift: <strong>@currentShift.Replace("S", "")</strong>
                    </span>
                    <span class="badge bg-primary text-light border p-2 fs-6">
                        🕒 @DateTime.Now.ToString("HH:mm:ss")
                    </span>
                </div>
                <div class="badge bg-primary text-light border p-2 fs-6 d-block mb-1">
                    @DateTime.Now.ToString("dddd", System.Globalization.CultureInfo.GetCultureInfo("id-ID"))
                </div>
                <div class="badge bg-primary text-light border p-2 fs-6 d-block">
                    📅 @DateTime.Now.ToString("dd/MM/yyyy")
                </div>
            </div>
        </div>
    </div>

    @if (logs == null)
    {
        <div class="alert alert-info">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            Menghubungkan ke Database...
        </div>
    }
    else
    {
        <div class="row g-3">
            @{
                var index = 1;
            }
            @foreach (var mesin in mesinList)
            {
                var data = logs.FirstOrDefault(x => x.nama_mesin_proses == mesin);
                var isDataFresh = false;
                if (data != null)
                {
                    var timeDifference = DateTime.Now - data.waktu;
                    isDataFresh = timeDifference.TotalSeconds <= 5;
                }
                
                var timer = (data?.data_timer ?? 0);
                if (!isDataFresh)
                {
                    timer = 0;
                }
                
                var isError = timer > 0 && isDataFresh;
                var mesinNameOnly = mesin.Split(" - ")[1];
                
                <div class="col-12 col-sm-6 col-md-4 col-lg-3 col-xl-2">
                    <div class="card h-100 shadow-sm border-0 @(isError ? "border-danger border-2" : "")">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title fw-bold text-dark mb-0" style="font-size: 0.9rem; line-height: 1.3;">
                                    @index. @mesinNameOnly
                                </h6>
                                @if (isError)
                                {
                                    <span class="badge bg-danger">⚠️</span>
                                }
                                else
                                {
                                    <span>✅</span>
                                }
                            </div>
                            
                            <!-- Shift Badge -->
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">Shift:</small>
                                <span class="badge bg-primary" style="font-size: 0.75rem; padding: 4px 14px;">
                                    @currentShift.Replace("S", "")
                                </span>
                            </div>
                            
                            <!-- Timer Section -->
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">Timer:</small>
                                <span class="badge bg-secondary font-monospace" style="font-size: 0.75rem; padding: 4px 10px;">
                                    @FormatTimer(timer)
                                </span>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="mt-3">
                                <div class="progress" style="height: 6px; border-radius: 3px;">
                                    <div class="progress-bar @(isError ? "bg-danger" : "bg-success")" 
                                         role="progressbar" 
                                         style="width: 100%; border-radius: 3px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                index++;
            }
        </div>
    }
    
                <!-- Logo SHARP di bawah -->
                <div class="mt-4 mb-3">
                    <img src="images/sharp-pe-logo.svg" alt="SHARP Logo" style="width: 220px; height: auto;" />
                </div>
            </div>
        </div>
        
        <!-- PAGE 2: Production Line View -->
        <div class="carousel-page">
            <!-- Production Line Container - Full Page -->
                <div class="production-line-container">
                    
                    <!-- Content Wrapper with Fixed Aspect Ratio -->
                    <div class="production-content-wrapper">
                    
                    <!-- Header Left Top -->
                    <div class="production-header-left-top" style="position: absolute; z-index: 500;">
                        <h1 class="production-main-title">CENTRALIZED</h1>
                        <h1 class="production-main-title">MONITORING SYSTEM</h1>
                        <p class="production-main-subtitle">WASHING MACHINE DIVISION</p>
                        
                        <div class="production-info-badges">
                            <div class="info-row">
                                <span class="info-badge day">@DateTime.Now.ToString("dddd", System.Globalization.CultureInfo.GetCultureInfo("id-ID"))</span>
                                <span class="info-badge shift">SHIFT @currentShift.Replace("S", "")</span>
                            </div>
                            <div class="info-row">
                                <span class="info-badge date">@DateTime.Now.ToString("dd/MM/yyyy")</span>
                                <span class="info-badge time">@DateTime.Now.ToString("HH:mm:ss")</span>
                            </div>
                        </div>
                        
                        <!-- Legend -->
                        <div class="production-header-legend">
                            <div class="header-legend-item">
                                <div class="header-legend-dot normal"></div>
                                <span>Normal Condition</span>
                            </div>
                            <div class="header-legend-item">
                                <div class="header-legend-dot error"></div>
                                <span>Trouble Condition</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="production-line-overlay"></div>
        
                    
                    <!-- LINE A Indicators (Bottom) with Labels -->
                    @{
                        var lineAProcesses = GetLineAProcesses();
                        var lineAIndex = 0;
                    }
                    @foreach (var process in lineAProcesses)
                    {
                        var position = GetLineAPosition(lineAIndex);
                        var isError = IsProcessError(process, "A");
                        var timerDisplay = GetTimerForProcess(process, "A");
                        
                        <div class="process-point-wrapper" style="top: @position.top; left: @position.left;">
                            <div class="process-indicator-dot @(isError ? "error" : "normal")"></div>
                            
                            <!-- Label for NORMAL (show on hover) -->
                            @if (!isError)
                            {
                                <div class="process-label-tag normal-tag">
                                    <span class="label-text">@process</span>
                                </div>
                            }
                            
                            <!-- Label for ERROR (always visible) -->
                            @if (isError)
                            {
                                <div class="process-label-tag error-tag">
                                    <span class="label-text">@process</span>
                                    <span class="label-timer">@timerDisplay</span>
                                </div>
                            }
                        </div>
                        lineAIndex++;
                    }
                    
                    <!-- LINE B Indicators (Top) with Labels -->
                    @{
                        var lineBProcesses = GetLineBProcesses();
                        var lineBIndex = 0;
                    }
                    @foreach (var process in lineBProcesses)
                    {
                        var position = GetLineBPosition(lineBIndex);
                        var isError = IsProcessError(process, "B");
                        var timerDisplay = GetTimerForProcess(process, "B");
                        
                        <div class="process-point-wrapper" style="top: @(position.top)px; left: @(position.left)px;">
                            <div class="process-indicator-dot @(isError ? "error" : "normal")"></div>
                            
                            <!-- Label for NORMAL (show on hover) -->
                            @if (!isError)
                            {
                                <div class="process-label-tag normal-tag">
                                    <span class="label-text">@process</span>
                                </div>
                            }
                            
                            <!-- Label for ERROR (always visible) -->
                            @if (isError)
                            {
                                <div class="process-label-tag error-tag">
                                    <span class="label-text">@process</span>
                                    <span class="label-timer">@timerDisplay</span>
                                </div>
                            }
                        </div>
                        lineBIndex++;
                    }
                    
                    <!-- Summary Cards Container (RIGHT SIDE) -->
                    <div style="position: absolute; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 15px; max-width: 400px;">
                        
                        <!-- LINE A Summary Cards (ATAS) -->
                        <div class="line-summary-container line-a-summary" style="position: relative; top: 0; right: 0;">
                            <div class="line-title-label">LINE A</div>
                            <div class="summary-cards-row">
                                <div class="summary-card-new process-stop">
                                    <div class="summary-card-label">PROCESS STOP</div>
                                    <div class="summary-card-number">@GetProcessStopTimeValue("A")</div>
                                    <div class="summary-card-badge">@GetProcessStopTimeUnit("A")</div>
                                </div>
                                <div class="summary-card-new machine-stop">
                                    <div class="summary-card-label">MACHINE STOP</div>
                                    <div class="summary-card-number">@GetMachineStopTimeValue("A")</div>
                                    <div class="summary-card-badge">@GetMachineStopTimeUnit("A")</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- LINE B Summary Cards (BAWAH) -->
                        <div class="line-summary-container line-b-summary" style="position: relative; top: 0; right: 0;">
                            <div class="line-title-label">LINE B</div>
                            <div class="summary-cards-row">
                                <div class="summary-card-new process-stop">
                                    <div class="summary-card-label">PROCESS STOP</div>
                                    <div class="summary-card-number">@GetProcessStopTimeValue("B")</div>
                                    <div class="summary-card-badge">@GetProcessStopTimeUnit("B")</div>
                                </div>
                                <div class="summary-card-new machine-stop">
                                    <div class="summary-card-label">MACHINE STOP</div>
                                    <div class="summary-card-number">@GetMachineStopTimeValue("B")</div>
                                    <div class="summary-card-badge">@GetMachineStopTimeUnit("B")</div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Logo SHARP Bottom Left -->
                    <div class="production-logo-container">
                        <img src="images/sharp-pe-logo.svg" alt="SHARP Logo" class="sharp-logo-image" />
                    </div>
                    
                    </div>
                    <!-- End Content Wrapper -->
                </div>
        </div>
        
        <!-- PAGE 3: Counter Dashboard -->
        <div class="carousel-page">
            <div class="counter-dashboard-container @(isDarkMode ? "dark-mode" : "light-mode")">
                <!-- Dark/Light Mode Toggle -->
                <button class="theme-toggle-btn" @onclick="ToggleTheme">
                    @if (isDarkMode)
                    {
                        <span>☀️</span>
                    }
                    else
                    {
                        <span>🌙</span>
                    }
                </button>
                
                <div class="counter-header">
                    <div class="counter-header-left">
                    </div>
                </div>

                <div class="counter-lines-container">
                    <!-- LINE A -->
                    <div class="counter-line-section">
                        <div class="counter-line-header">
                            <div>
                                <h2 class="counter-line-title">COUNTER LINE A</h2>
                                <h3 class="counter-line-model">ESMI000TGG</h3>
                            </div>
                        </div>

                        <div class="counter-cards-grid">
                            <!-- Row 1: Main Counter (Full Width) -->
                            <div class="counter-main-card counter-row-full">
                                <div class="counter-main-number">1200</div>
                                <div class="counter-main-label">Unit</div>
                            </div>

                            <!-- Row 2: Target Plan & Difference (Side by Side) -->
                            <div class="counter-secondary-card">
                                <div class="counter-secondary-label">TARGET PLAN</div>
                                <div class="counter-secondary-number">-1300</div>
                                <div class="counter-secondary-badge">Unit</div>
                            </div>

                            <div class="counter-secondary-card">
                                <div class="counter-secondary-label">DIFFERENCE</div>
                                <div class="counter-secondary-number">-1300</div>
                                <div class="counter-secondary-badge">Unit</div>
                            </div>
                        
                            <!-- Row 3: Process Stop & Machine Stop (Side by Side) -->
                            <div class="counter-bottom-card">
                                <div class="counter-bottom-label">PROCESS STOP</div>
                                <div class="counter-bottom-number">@GetProcessStopTimeValue("A")</div>
                                <div class="counter-bottom-badge">@GetProcessStopTimeUnit("A")</div>
                            </div>

                            <div class="counter-bottom-card">
                                <div class="counter-bottom-label">MACHINE STOP</div>
                                <div class="counter-bottom-number">@GetMachineStopTimeValue("A")</div>
                                <div class="counter-bottom-badge">@GetMachineStopTimeUnit("A")</div>
                            </div>
                        </div>
                    </div>

                    <!-- LINE B -->
                    <div class="counter-line-section">
                        <div class="counter-line-header">
                            <div>
                                <h2 class="counter-line-title">COUNTER LINE B</h2>
                                <h3 class="counter-line-model">EST80MWPK</h3>
                            </div>
                        </div>

                        <div class="counter-cards-grid">
                            <!-- Row 1: Main Counter (Full Width) -->
                            <div class="counter-main-card counter-row-full">
                                <div class="counter-main-number">1200</div>
                                <div class="counter-main-label">Unit</div>
                            </div>

                            <!-- Row 2: Target Plan & Difference (Side by Side) -->
                            <div class="counter-secondary-card">
                                <div class="counter-secondary-label">TARGET PLAN</div>
                                <div class="counter-secondary-number">-1300</div>
                                <div class="counter-secondary-badge">Unit</div>
                            </div>

                            <div class="counter-secondary-card">
                                <div class="counter-secondary-label">DIFFERENCE</div>
                                <div class="counter-secondary-number">-1300</div>
                                <div class="counter-secondary-badge">Unit</div>
                            </div>
                        
                            <!-- Row 3: Process Stop & Machine Stop (Side by Side) -->
                            <div class="counter-bottom-card">
                                <div class="counter-bottom-label">PROCESS STOP</div>
                                <div class="counter-bottom-number">@GetProcessStopTimeValue("B")</div>
                                <div class="counter-bottom-badge">@GetProcessStopTimeUnit("B")</div>
                            </div>

                            <div class="counter-bottom-card">
                                <div class="counter-bottom-label">MACHINE STOP</div>
                                <div class="counter-bottom-number">@GetMachineStopTimeValue("B")</div>
                                <div class="counter-bottom-badge">@GetMachineStopTimeUnit("B")</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
</div>

@code {
    private List<ErrorLog>? logs;
    private System.Threading.Timer? timer;
    private string currentShift = "S1";
    private int currentPage = 0;
    private bool isDarkMode = true; // Default dark mode
    private bool sidebarExpanded = false; // Track sidebar state
    
    private List<string> processStopNames = new List<string>
    {
        "Base to Tub Stop",
        "Flange Screw Stop",
        "Wiring Stop",
        "Visual Instructional Stop",
        "FA Stop",
        "Feed Water Stop",
        "Inspection Room Stop",
        "Back Cover Stop",
        "Waranty Stop",
        "Bottom Pad Stop",
        "Packing Stop",
        "Finish Packing Stop"
    };
    
    private List<string> machineStopNames = new List<string>
    {
        "Auto Bellow Error",
        "Turn Machine Error",
        "Half Transfer Error",
        "Auto Water Error",
        "I/W Test Error",
        "Washing Perform Test Error",
        "Dehydration Test Error",
        "Transfer Packing Error",
        "Auto Folding Error",
        "Straping #1 Error",
        "Straping #2 Error",
        "Lifter Error"
    };
    
    private List<string> mesinNames = new List<string>
    {
        "Auto Bellow Error",
        "Base to Tub Stop",
        "Turn Machine Error",
        "Flange Screw Stop",
        "Wiring Stop",
        "Half Transfer Error",
        "Visual Instructional Stop",
        "Auto Water Error",
        "I/W Test Error",
        "FA Stop",
        "Washing Perform Test Error",
        "Feed Water Stop",
        "Inspection Room Stop",
        "Dehydration Test Error",
        "Back Cover Stop",
        "Waranty Stop",
        "Transfer Packing Error",
        "Bottom Pad Stop",
        "Packing Stop",
        "Finish Packing Stop",
        "Auto Folding Error",
        "Straping #1 Error",
        "Straping #2 Error",
        "Lifter Error"
    };
    
    private List<string> mesinList => mesinNames.Select(name => $"{currentShift} - {name}").ToList();

    // Carousel Navigation
    private void NextPage()
    {
        if (currentPage < 2) currentPage++;
    }

    private void PreviousPage()
    {
        if (currentPage > 0) currentPage--;
    }

    private void GoToPage(int page)
    {
        currentPage = page;
    }

    // Toggle Dark/Light Mode
    private void ToggleTheme()
    {
        isDarkMode = !isDarkMode;
    }

    // Line A Processes (sama dengan urutan mesinNames)
    private List<string> GetLineAProcesses()
    {
        return mesinNames;
    }

    // Line B Processes (untuk sementara kosong/dummy karena belum ada database)
    private List<string> GetLineBProcesses()
    {
        // Return empty list atau dummy data karena Line B belum ada database
        return new List<string>();
    }

    // Posisi indikator untuk Line A (bottom line) - MENGGUNAKAN PERSENTASE
    private (string top, string left) GetLineAPosition(int index)
    {
        // LINE A: Bottom line - dari kiri ke kanan mengikuti conveyor
        // Menggunakan persentase agar responsive di semua ukuran layar
        // Base resolution: 1920x1080 untuk kalkulasi persentase
        string[] leftPositions = new string[] {
            "70.8%",    // 0: Auto Bellow Error (1145/1920)
            "68.2%",    // 1: Base to Tub Stop (1103/1920)
            "65.75%",    // 2: Turn Machine Error (1063/1920)
            "64.1%",    // 3: Flange Screw Stop (1039.5/1920)
            "61.6%",    // 4: Wiring Stop (1181/1920)
            "59.3%",    // 5: Half Transfer Error (1148/1920)
            "57.7%",    // 6: Visual Instructional Stop (1118/1920)
            "55.9%",    // 7: Auto Water Error (1075/1920)
            "54.3%",    // 8: I/W Test Error (1041/1920)
            "52.85%",    // 9: FA Stop (1013/1920)
            "51.1%",    // 10: Washing Perform Test Error (984/1920)
            "49.8%",    // 11: Feed Water Stop (960/1920)
            "48.45%",    // 12: Inspection Room Stop (931/1920)
            "46.9%",    // 13: Dehydration Test Error (902/1920)
            "44.65%",    // 14: Back Cover Stop (864/1920)
            "42.9%",    // 15: Waranty Stop (835/1920)
            "41.45%",    // 16: Transfer Packing Error (792/1920)
            "39.9%",    // 17: Bottom Pad Stop (753/1920)
            "38.2%",    // 18: Packing Stop (720/1920)
            "36.4%",    // 19: Finish Packing Stop (691/1920)
            "35.1%",    // 20: Auto Folding Error (667/1920)
            "33.85%",    // 21: Straping #1 Error (641/1920)
            "32.55%",    // 22: Straping #2 Error (619/1920)
            "30.75%"     // 23: Lifter Error (595/1920)
        };
        
        string[] topPositions = new string[] {
            "12.55%",    // 0: Auto Bellow Error (116.75/1080)
            "18.1%",    // 1: Base to Tub Stop (166.75/1080)
            "23.1%",    // 2: Turn Machine Error (217/1080)
            "26.2%",    // 3: Flange Screw Stop (245/1080)
            "31.2%",    // 4: Wiring Stop (340/1080)
            "35.6%",    // 5: Half Transfer Error (381/1080)
            "38.6%",    // 6: Visual Instructional Stop (413/1080)
            "42.5%",    // 7: Auto Water Error (459/1080)
            "45.83%",    // 8: I/W Test Error (497/1080)
            "49.2%",    // 9: FA Stop (529/1080)
            "52.92%",    // 10: Washing Perform Test Error (562/1080)
            "55.8%",    // 11: Feed Water Stop (591/1080)
            "58.6%",    // 12: Inspection Room Stop (624/1080)
            "61.5%",    // 13: Dehydration Test Error (659/1080)
            "65.65%",    // 14: Back Cover Stop (702/1080)
            "69.2%",    // 15: Waranty Stop (734/1080)
            "72.0%",    // 16: Transfer Packing Error (778/1080)
            "74.9%",    // 17: Bottom Pad Stop (815/1080)
            "78.5%",    // 18: Packing Stop (848/1080)
            "82%",    // 19: Finish Packing Stop (877/1080)
            "84.8%",    // 20: Auto Folding Error (904/1080)
            "87.4%",    // 21: Straping #1 Error (932/1080)
            "90%",    // 22: Straping #2 Error (958/1080)
            "93.55%"     // 23: Lifter Error (988/1080)
        };
        
        if (index < leftPositions.Length)
        {
            return (topPositions[index], leftPositions[index]);
        }
        
        return ("65%", "30%");
    }

    // Posisi indikator untuk Line B (top line)
    private (double top, double left) GetLineBPosition(int index)
    {
        // LINE B: Top line - dari kiri ke kanan mengikuti conveyor
        double[] leftPositions = new double[] {
            8, 12, 16, 20, 24, 28, 32, 36, 40, 44, 48, 52,
            56, 60, 64, 68, 72, 76, 80, 84, 88, 92, 94, 96
        };
        
        double[] topPositions = new double[] {
            22, 20, 22, 20, 22, 20, 22, 20, 22, 20, 22, 20,
            22, 20, 22, 20, 22, 20, 22, 20, 22, 20, 22, 20
        };
        
        if (index < leftPositions.Length)
        {
            return (topPositions[index], leftPositions[index]);
        }
        
        return (20, 5 + (index * 3.8));
    }

    // Check if process has error
    private bool IsProcessError(string processName, string line)
    {
        var fullName = $"{currentShift} - {processName}";
        var data = logs?.FirstOrDefault(x => x.nama_mesin_proses == fullName);
        
        if (data == null) return false;
        
        var timeDifference = DateTime.Now - data.waktu;
        var isDataFresh = timeDifference.TotalSeconds <= 5;
        
        return data.data_timer > 0 && isDataFresh;
    }

    // Get timer for process in error state
    private string GetTimerForProcess(string processName, string line)
    {
        var fullName = $"{currentShift} - {processName}";
        var data = logs?.FirstOrDefault(x => x.nama_mesin_proses == fullName);
        
        if (data == null) return "";
        
        var timeDifference = DateTime.Now - data.waktu;
        var isDataFresh = timeDifference.TotalSeconds <= 5;
        
        if (!isDataFresh || data.data_timer <= 0) return "";
        
        return FormatTimerShort(data.data_timer);
    }

    // Get timer display for process
    private string GetTimerDisplay(string processName)
    {
        var fullName = $"{currentShift} - {processName}";
        var data = logs?.FirstOrDefault(x => x.nama_mesin_proses == fullName);
        
        if (data == null) return "";
        
        var timeDifference = DateTime.Now - data.waktu;
        var isDataFresh = timeDifference.TotalSeconds <= 5;
        
        if (!isDataFresh) return "";
        
        return $"{FormatTimerShort(data.data_timer)} - {processName}";
    }

    // Get Process Stop count (in minutes)
    private int GetProcessStopCount(string line)
    {
        if (logs == null) return 0;
        
        int totalSeconds = 0;
        foreach (var process in processStopNames)
        {
            var fullName = $"{currentShift} - {process}";
            var data = logs.FirstOrDefault(x => x.nama_mesin_proses == fullName);
            
            if (data != null)
            {
                var timeDifference = DateTime.Now - data.waktu;
                var isDataFresh = timeDifference.TotalSeconds <= 5;
                
                if (isDataFresh && data.data_timer > 0)
                {
                    totalSeconds += data.data_timer;
                }
            }
        }
        
        return totalSeconds / 60; // Convert to minutes
    }

    // Get Machine Stop count (in minutes)
    private int GetMachineStopCount(string line)
    {
        if (logs == null) return 0;
        
        int totalSeconds = 0;
        foreach (var process in machineStopNames)
        {
            var fullName = $"{currentShift} - {process}";
            var data = logs.FirstOrDefault(x => x.nama_mesin_proses == fullName);
            
            if (data != null)
            {
                var timeDifference = DateTime.Now - data.waktu;
                var isDataFresh = timeDifference.TotalSeconds <= 5;
                
                if (isDataFresh && data.data_timer > 0)
                {
                    totalSeconds += data.data_timer;
                }
            }
        }
        
        return totalSeconds / 60; // Convert to minutes
    }

    // Get Process Stop time (formatted as s/m/h)
    private string GetProcessStopTime(string line)
    {
        if (logs == null) return "0s";
        
        int totalSeconds = 0;
        foreach (var process in processStopNames)
        {
            var fullName = $"{currentShift} - {process}";
            var data = logs.FirstOrDefault(x => x.nama_mesin_proses == fullName);
            
            if (data != null)
            {
                var timeDifference = DateTime.Now - data.waktu;
                var isDataFresh = timeDifference.TotalSeconds <= 5;
                
                if (isDataFresh && data.data_timer > 0)
                {
                    totalSeconds += data.data_timer;
                }
            }
        }
        
        return FormatTimerCompact(totalSeconds);
    }

    // Get Machine Stop time (formatted as s/m/h)
    private string GetMachineStopTime(string line)
    {
        if (logs == null) return "0s";
        
        int totalSeconds = 0;
        foreach (var process in machineStopNames)
        {
            var fullName = $"{currentShift} - {process}";
            var data = logs.FirstOrDefault(x => x.nama_mesin_proses == fullName);
            
            if (data != null)
            {
                var timeDifference = DateTime.Now - data.waktu;
                var isDataFresh = timeDifference.TotalSeconds <= 5;
                
                if (isDataFresh && data.data_timer > 0)
                {
                    totalSeconds += data.data_timer;
                }
            }
        }
        
        return FormatTimerCompact(totalSeconds);
    }

    // Format timer for summary cards (compact version)
    private string FormatTimerCompact(int seconds)
    {
        if (seconds >= 3600) 
        {
            int hours = seconds / 3600;
            int minutes = (seconds % 3600) / 60;
            if (minutes > 0)
                return $"{hours}h {minutes}m";
            else
                return $"{hours}h";
        }
        else if (seconds >= 60)
        {
            int minutes = seconds / 60;
            int secs = seconds % 60;
            if (secs > 0)
                return $"{minutes}m {secs}s";
            else
                return $"{minutes}m";
        }
        else 
        {
            return $"{seconds}s";
        }
    }

    // Get Process Stop time value (only the number)
    private string GetProcessStopTimeValue(string line)
    {
        if (logs == null) return "0";
        
        // Line B belum ada database, return 0
        if (line == "B") return "0";
        
        int totalSeconds = 0;
        foreach (var process in processStopNames)
        {
            var fullName = $"{currentShift} - {process}";
            var data = logs.FirstOrDefault(x => x.nama_mesin_proses == fullName);
            
            if (data != null)
            {
                var timeDifference = DateTime.Now - data.waktu;
                var isDataFresh = timeDifference.TotalSeconds <= 5;
                
                if (isDataFresh && data.data_timer > 0)
                {
                    totalSeconds += data.data_timer;
                }
            }
        }
        
        if (totalSeconds >= 3600)
        {
            int hours = totalSeconds / 3600;
            int minutes = (totalSeconds % 3600) / 60;
            if (minutes > 0)
                return $"{hours}:{minutes:D2}";
            else
                return $"{hours}";
        }
        else if (totalSeconds >= 60)
        {
            int minutes = totalSeconds / 60;
            int secs = totalSeconds % 60;
            if (secs > 0)
                return $"{minutes}:{secs:D2}";
            else
                return $"{minutes}";
        }
        else
        {
            return $"{totalSeconds}";
        }
    }

    // Get Process Stop time unit
    private string GetProcessStopTimeUnit(string line)
    {
        if (logs == null) return "SEC";
        
        // Line B belum ada database, return SEC
        if (line == "B") return "SEC";
        
        int totalSeconds = 0;
        foreach (var process in processStopNames)
        {
            var fullName = $"{currentShift} - {process}";
            var data = logs.FirstOrDefault(x => x.nama_mesin_proses == fullName);
            
            if (data != null)
            {
                var timeDifference = DateTime.Now - data.waktu;
                var isDataFresh = timeDifference.TotalSeconds <= 5;
                
                if (isDataFresh && data.data_timer > 0)
                {
                    totalSeconds += data.data_timer;
                }
            }
        }
        
        if (totalSeconds >= 3600)
            return "HOUR";
        else if (totalSeconds >= 60)
            return "MIN";
        else
            return "SEC";
    }

    // Get Machine Stop time value (only the number)
    private string GetMachineStopTimeValue(string line)
    {
        if (logs == null) return "0";
        
        // Line B belum ada database, return 0
        if (line == "B") return "0";
        
        int totalSeconds = 0;
        foreach (var process in machineStopNames)
        {
            var fullName = $"{currentShift} - {process}";
            var data = logs.FirstOrDefault(x => x.nama_mesin_proses == fullName);
            
            if (data != null)
            {
                var timeDifference = DateTime.Now - data.waktu;
                var isDataFresh = timeDifference.TotalSeconds <= 5;
                
                if (isDataFresh && data.data_timer > 0)
                {
                    totalSeconds += data.data_timer;
                }
            }
        }
        
        if (totalSeconds >= 3600)
        {
            int hours = totalSeconds / 3600;
            int minutes = (totalSeconds % 3600) / 60;
            if (minutes > 0)
                return $"{hours}:{minutes:D2}";
            else
                return $"{hours}";
        }
        else if (totalSeconds >= 60)
        {
            int minutes = totalSeconds / 60;
            int secs = totalSeconds % 60;
            if (secs > 0)
                return $"{minutes}:{secs:D2}";
            else
                return $"{minutes}";
        }
        else
        {
            return $"{totalSeconds}";
        }
    }

    // Get Machine Stop time unit
    private string GetMachineStopTimeUnit(string line)
    {
        if (logs == null) return "SEC";
        
        // Line B belum ada database, return SEC
        if (line == "B") return "SEC";
        
        int totalSeconds = 0;
        foreach (var process in machineStopNames)
        {
            var fullName = $"{currentShift} - {process}";
            var data = logs.FirstOrDefault(x => x.nama_mesin_proses == fullName);
            
            if (data != null)
            {
                var timeDifference = DateTime.Now - data.waktu;
                var isDataFresh = timeDifference.TotalSeconds <= 5;
                
                if (isDataFresh && data.data_timer > 0)
                {
                    totalSeconds += data.data_timer;
                }
            }
        }
        
        if (totalSeconds >= 3600)
            return "HOUR";
        else if (totalSeconds >= 60)
            return "MIN";
        else
            return "SEC";
    }

    protected override void OnInitialized()
    {
        LoadData();

        timer = new System.Threading.Timer(async _ =>
        {
            LoadData();
            await InvokeAsync(StateHasChanged);
        }, null, 0, 1000); 
    }

    private void LoadData()
    {
        logs = ServiceKita.GetLatestLogs();
        
        if (logs != null && logs.Any())
        {
            var firstLog = logs.FirstOrDefault();
            if (firstLog != null && !string.IsNullOrEmpty(firstLog.nama_mesin_proses))
            {
                var parts = firstLog.nama_mesin_proses.Split('-');
                if (parts.Length > 0)
                {
                    var shiftPart = parts[0].Trim();
                    if (shiftPart.StartsWith("S") && (shiftPart == "S1" || shiftPart == "S2" || shiftPart == "S3"))
                    {
                        currentShift = shiftPart;
                    }
                }
            }
        }
        
        // ATAU deteksi shift berdasarkan jam
        // currentShift = GetShiftByTime();
    }
    
    // Method untuk deteksi shift berdasarkan jam
    private string GetShiftByTime()
    {
        var now = DateTime.Now;
        var hour = now.Hour;
        var minute = now.Minute;
        
        
        if ((hour == 7 && minute >= 56) || (hour > 7 && hour < 17) || (hour == 17 && minute == 0))
        {
            return "S1";
        }
        else if ((hour == 17 && minute >= 1) || (hour > 17 && hour <= 23) || (hour == 0 && minute <= 25))
        {
            return "S2";
        }
        else
        {
            return "S3";
        }
    }
    
    
    private string FormatTimerShort(int seconds)
    {
        if (seconds >= 3600) 
        {
            int hours = seconds / 3600;
            int minutes = (seconds % 3600) / 60;
            return $"{hours}h {minutes}m";
        }
        else if (seconds >= 60)
        {
            int minutes = seconds / 60;
            int secs = seconds % 60;
            return $"{minutes}m {secs}s";
        }
        else 
        {
            return $"{seconds}s";
        }
    }
    
    private string FormatTimer(int seconds)
    {
        if (seconds >= 3600) 
        {
            int hours = seconds / 3600;
            int minutes = (seconds % 3600) / 60;
            int secs = seconds % 60;
            
            if (minutes > 0 && secs > 0)
                return $"{hours}h {minutes}m {secs}s";
            else if (minutes > 0)
                return $"{hours}h {minutes}m";
            else
                return $"{hours}h";
        }
        else if (seconds >= 60)
        {
            int minutes = seconds / 60;
            int secs = seconds % 60;
            
            if (secs > 0)
                return $"{minutes}m {secs}s";
            else
                return $"{minutes}m";
        }
        else 
        {
            return $"{seconds}s";
        }
    }

    public void Dispose()
    {
        timer?.Dispose();
    }
}