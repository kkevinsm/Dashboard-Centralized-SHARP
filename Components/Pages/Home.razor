@page "/"
@rendermode InteractiveServer
@using CentralizedDashboard.Models
@using CentralizedDashboard.Services
@inject MesinService ServiceKita 
@* ^ Memanggil service MySQL *@

<PageTitle>Monitoring Dashboard</PageTitle>

<link rel="stylesheet" href="home-responsive.css" />

<div class="container-fluid mt-3">
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h1 class="text-primary fw-bold mb-0">CENTRALIZED</h1>
            <h1 class="text-primary fw-bold">MONITORING SYSTEM</h1>
            <p class="text-muted mb-0" style="font-size: 1.4rem;">WASHING MACHINE DIVISION</p>
        </div>
        <div class="text-end">
            <div class="d-inline-block">
                <div class="mb-1 d-flex align-items-center">
                    <span class="badge bg-primary p-2 fs-6 me-2">
                        Shift: <strong>@currentShift.Replace("S", "")</strong>
                    </span>
                    <span class="badge bg-primary text-light border p-2 fs-6">
                        🕒 @DateTime.Now.ToString("HH:mm:ss")
                    </span>
                </div>
                <div class="badge bg-primary text-light border p-2 fs-6 d-block mb-1">
                    @DateTime.Now.ToString("dddd", System.Globalization.CultureInfo.GetCultureInfo("id-ID"))
                </div>
                <div class="badge bg-primary text-light border p-2 fs-6 d-block">
                    📅 @DateTime.Now.ToString("dd/MM/yyyy")
                </div>
            </div>
        </div>
    </div>

    @if (logs == null)
    {
        <div class="alert alert-info">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            Menghubungkan ke Database...
        </div>
    }
    else
    {
        <div class="row g-3">
            @{
                var index = 1;
            }
            @foreach (var mesin in mesinList)
            {
                var data = logs.FirstOrDefault(x => x.nama_mesin_proses == mesin);
                var isDataFresh = false;
                if (data != null)
                {
                    var timeDifference = DateTime.Now - data.waktu;
                    isDataFresh = timeDifference.TotalSeconds <= 5;
                }
                
                var timer = (data?.data_timer ?? 0);
                if (!isDataFresh)
                {
                    timer = 0;
                }
                
                var isError = timer > 0 && isDataFresh;
                var mesinNameOnly = mesin.Split(" - ")[1];
                
                <div class="col-12 col-sm-6 col-md-4 col-lg-3 col-xl-2">
                    <div class="card h-100 shadow-sm border-0 @(isError ? "border-danger border-2" : "")">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title fw-bold text-dark mb-0" style="font-size: 0.9rem; line-height: 1.3;">
                                    @index. @mesinNameOnly
                                </h6>
                                @if (isError)
                                {
                                    <span class="badge bg-danger">⚠️</span>
                                }
                                else
                                {
                                    <span>✅</span>
                                }
                            </div>
                            
                            <!-- Shift Badge -->
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">Shift:</small>
                                <span class="badge bg-primary" style="font-size: 0.75rem; padding: 4px 14px;">
                                    @currentShift.Replace("S", "")
                                </span>
                            </div>
                            
                            <!-- Timer Section -->
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">Timer:</small>
                                <span class="badge bg-secondary font-monospace" style="font-size: 0.75rem; padding: 4px 10px;">
                                    @FormatTimer(timer)
                                </span>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="mt-3">
                                <div class="progress" style="height: 6px; border-radius: 3px;">
                                    <div class="progress-bar @(isError ? "bg-danger" : "bg-success")" 
                                         role="progressbar" 
                                         style="width: 100%; border-radius: 3px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                index++;
            }
        </div>
    }
</div>

@code {
    private List<ErrorLog>? logs;
    private System.Threading.Timer? timer;
    private string currentShift = "S1";
    
    private List<string> mesinNames = new List<string>
    {
        "Auto Bellow Error",
        "Base to Tub Stop",
        "Turn Machine Error",
        "Flange Screw Stop",
        "Wiring Stop",
        "Half Transfer Error",
        "Visual Instructional Stop",
        "Auto Water Error",
        "I/W Test Error",
        "FA Stop",
        "Washing Perform Test Error",
        "Feed Water Stop",
        "Inspection Room Stop",
        "Dehydration Test Error",
        "Back Cover Stop",
        "Waranty Stop",
        "Transfer Packing Error",
        "Bottom Pad Stop",
        "Packing Stop",
        "Finish Packing Stop",
        "Auto Folding Error",
        "Straping #1 Error",
        "Straping #2 Error",
        "Lifter Error"
    };
    
    private List<string> mesinList => mesinNames.Select(name => $"{currentShift} - {name}").ToList();

    protected override void OnInitialized()
    {
        LoadData();

        timer = new System.Threading.Timer(async _ =>
        {
            LoadData();
            await InvokeAsync(StateHasChanged);
        }, null, 0, 1000); 
    }

    private void LoadData()
    {
        logs = ServiceKita.GetLatestLogs();
        
        if (logs != null && logs.Any())
        {
            var firstLog = logs.FirstOrDefault();
            if (firstLog != null && !string.IsNullOrEmpty(firstLog.nama_mesin_proses))
            {
                var parts = firstLog.nama_mesin_proses.Split('-');
                if (parts.Length > 0)
                {
                    var shiftPart = parts[0].Trim();
                    if (shiftPart.StartsWith("S") && (shiftPart == "S1" || shiftPart == "S2" || shiftPart == "S3"))
                    {
                        currentShift = shiftPart;
                    }
                }
            }
        }
        
        // ATAU deteksi shift berdasarkan jam
        // currentShift = GetShiftByTime();
    }
    
    // Method untuk deteksi shift berdasarkan jam
    private string GetShiftByTime()
    {
        var now = DateTime.Now;
        var hour = now.Hour;
        var minute = now.Minute;
        
        
        if ((hour == 7 && minute >= 56) || (hour > 7 && hour < 17) || (hour == 17 && minute == 0))
        {
            return "S1";
        }
        else if ((hour == 17 && minute >= 1) || (hour > 17 && hour <= 23) || (hour == 0 && minute <= 25))
        {
            return "S2";
        }
        else
        {
            return "S3";
        }
    }
    
    private string FormatTimer(int seconds)
    {
        if (seconds >= 3600) 
        {
            int hours = seconds / 3600;
            int minutes = (seconds % 3600) / 60;
            int secs = seconds % 60;
            
            if (minutes > 0 && secs > 0)
                return $"{hours}h {minutes}m {secs}s";
            else if (minutes > 0)
                return $"{hours}h {minutes}m";
            else
                return $"{hours}h";
        }
        else if (seconds >= 60)
        {
            int minutes = seconds / 60;
            int secs = seconds % 60;
            
            if (secs > 0)
                return $"{minutes}m {secs}s";
            else
                return $"{minutes}m";
        }
        else 
        {
            return $"{seconds}s";
        }
    }

    public void Dispose()
    {
        timer?.Dispose();
    }
}