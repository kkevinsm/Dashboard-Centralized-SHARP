@page "/"
@rendermode InteractiveServer
@using CentralizedDashboard.Models
@using CentralizedDashboard.Services
@inject MesinService ServiceKita 

<PageTitle>Monitoring Dashboard</PageTitle>

<link rel="stylesheet" href="home-responsive.css" />
<link rel="stylesheet" href="dashboard-carousel.css" />

<!-- Carousel Navigation -->
<button class="carousel-nav prev" @onclick="PreviousPage" disabled="@(currentPage == 0)">
    ‹
</button>
<button class="carousel-nav next" @onclick="NextPage" disabled="@(currentPage == 1)">
    ›
</button>

<!-- Page Indicators -->
<div class="carousel-indicators">
    <div class="carousel-indicator @(currentPage == 0 ? "active" : "")" @onclick="() => GoToPage(0)"></div>
    <div class="carousel-indicator @(currentPage == 1 ? "active" : "")" @onclick="() => GoToPage(1)"></div>
</div>

<div class="dashboard-carousel">
    <div class="carousel-container" style="transform: translateX(-@(currentPage * 50)%);">
        
        <!-- PAGE 1: Card Dashboard -->
        <div class="carousel-page">
            <div class="container-fluid mt-3 position-relative" style="min-height: 100vh;">
                <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h1 class="text-primary fw-bold mb-0">CENTRALIZED</h1>
            <h1 class="text-primary fw-bold">MONITORING SYSTEM</h1>
            <p class="text-muted mb-0" style="font-size: 1.4rem;">WASHING MACHINE DIVISION</p>
        </div>
        <div class="text-end">
            <div class="d-inline-block">
                <div class="mb-1 d-flex align-items-center">
                    <span class="badge bg-primary p-2 fs-6 me-2">
                        Shift: <strong>@currentShift.Replace("S", "")</strong>
                    </span>
                    <span class="badge bg-primary text-light border p-2 fs-6">
                        🕒 @DateTime.Now.ToString("HH:mm:ss")
                    </span>
                </div>
                <div class="badge bg-primary text-light border p-2 fs-6 d-block mb-1">
                    @DateTime.Now.ToString("dddd", System.Globalization.CultureInfo.GetCultureInfo("id-ID"))
                </div>
                <div class="badge bg-primary text-light border p-2 fs-6 d-block">
                    📅 @DateTime.Now.ToString("dd/MM/yyyy")
                </div>
            </div>
        </div>
    </div>

    @if (logs == null)
    {
        <div class="alert alert-info">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            Menghubungkan ke Database...
        </div>
    }
    else
    {
        <div class="row g-3">
            @{
                var index = 1;
            }
            @foreach (var mesin in mesinList)
            {
                var data = logs.FirstOrDefault(x => x.nama_mesin_proses == mesin);
                var isDataFresh = false;
                if (data != null)
                {
                    var timeDifference = DateTime.Now - data.waktu;
                    isDataFresh = timeDifference.TotalSeconds <= 5;
                }
                
                var timer = (data?.data_timer ?? 0);
                if (!isDataFresh)
                {
                    timer = 0;
                }
                
                var isError = timer > 0 && isDataFresh;
                var mesinNameOnly = mesin.Split(" - ")[1];
                
                <div class="col-12 col-sm-6 col-md-4 col-lg-3 col-xl-2">
                    <div class="card h-100 shadow-sm border-0 @(isError ? "border-danger border-2" : "")">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title fw-bold text-dark mb-0" style="font-size: 0.9rem; line-height: 1.3;">
                                    @index. @mesinNameOnly
                                </h6>
                                @if (isError)
                                {
                                    <span class="badge bg-danger">⚠️</span>
                                }
                                else
                                {
                                    <span>✅</span>
                                }
                            </div>
                            
                            <!-- Shift Badge -->
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">Shift:</small>
                                <span class="badge bg-primary" style="font-size: 0.75rem; padding: 4px 14px;">
                                    @currentShift.Replace("S", "")
                                </span>
                            </div>
                            
                            <!-- Timer Section -->
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">Timer:</small>
                                <span class="badge bg-secondary font-monospace" style="font-size: 0.75rem; padding: 4px 10px;">
                                    @FormatTimer(timer)
                                </span>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="mt-3">
                                <div class="progress" style="height: 6px; border-radius: 3px;">
                                    <div class="progress-bar @(isError ? "bg-danger" : "bg-success")" 
                                         role="progressbar" 
                                         style="width: 100%; border-radius: 3px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                index++;
            }
        </div>
    }
    
                <!-- Logo SHARP di bawah -->
                <div class="mt-4 mb-3">
                    <img src="images/sharp-pe-logo.svg" alt="SHARP Logo" style="width: 220px; height: auto;" />
                </div>
            </div>
        </div>
        
        <!-- PAGE 2: Production Line View -->
        <div class="carousel-page">
            <!-- Production Line Container - Full Page -->
                <div class="production-line-container">
                    <!-- Header Overlay -->
                    <div class="production-header-overlay">
                        <div class="production-header-left">
                            <h2 class="production-title">CENTRALIZED</h2>
                            <h2 class="production-title">MONITORING SYSTEM</h2>
                            <p class="production-subtitle">WASHING MACHINE DIVISION</p>
                        </div>
                        <div class="production-header-right">
                            <div class="production-shift-badge">Shift: <strong>@currentShift.Replace("S", "")</strong></div>
                            <div class="production-time-badge">🕒 @DateTime.Now.ToString("HH:mm:ss")</div>
                            <div class="production-date-badge">@DateTime.Now.ToString("dddd", System.Globalization.CultureInfo.GetCultureInfo("id-ID"))</div>
                            <div class="production-date-badge">📅 @DateTime.Now.ToString("dd/MM/yyyy")</div>
                        </div>
                    </div>
                    
                    <div class="production-line-overlay"></div>
                    
                    <!-- LINE A Label -->
                    <div class="line-label line-a">LINE A</div>
                    
                    <!-- LINE B Label -->
                    <div class="line-label line-b">LINE B</div>
                    
                    <!-- LINE A Indicators (Bottom) -->
                    @{
                        var lineAProcesses = GetLineAProcesses();
                        var lineAIndex = 0;
                    }
                    @foreach (var process in lineAProcesses)
                    {
                        var position = GetLineAPosition(lineAIndex);
                        var isError = IsProcessError(process, "A");
                        
                        <div class="process-indicator @(isError ? "error" : "normal")" style="top: @(position.top)%; left: @(position.left)%;">
                            <div class="process-label @(isError ? "error-label" : "normal-label")">
                                <span class="process-label-number">@(lineAIndex + 1)</span>
                                <span class="process-label-name">@process</span>
                                @if (isError)
                                {
                                    <span class="process-label-timer">@GetTimerDisplay(process)</span>
                                }
                            </div>
                        </div>
                        lineAIndex++;
                    }
                    
                    <!-- LINE B Indicators (Top) -->
                    @{
                        var lineBProcesses = GetLineBProcesses();
                        var lineBIndex = 0;
                    }
                    @foreach (var process in lineBProcesses)
                    {
                        var position = GetLineBPosition(lineBIndex);
                        var isError = IsProcessError(process, "B");
                        
                        <div class="process-indicator @(isError ? "error" : "normal")" style="top: @(position.top)%; left: @(position.left)%;">
                            <div class="process-label @(isError ? "error-label" : "normal-label")">
                                <span class="process-label-number">@(lineBIndex + 1)</span>
                                <span class="process-label-name">@process</span>
                                @if (isError)
                                {
                                    <span class="process-label-timer">@GetTimerDisplay(process)</span>
                                }
                            </div>
                        </div>
                        lineBIndex++;
                    }
                    
                    <!-- LINE A Summary Cards -->
                    <div class="line-summary-cards line-a">
                        <div class="summary-card process-stop">
                            <div class="summary-card-title">Process Stop</div>
                            <div class="summary-card-value">@GetProcessStopCount("A")</div>
                            <div class="summary-card-unit">minutes</div>
                        </div>
                        <div class="summary-card machine-stop">
                            <div class="summary-card-title">Machine Stop</div>
                            <div class="summary-card-value">@GetMachineStopCount("A")</div>
                            <div class="summary-card-unit">minutes</div>
                        </div>
                    </div>
                    
                    <!-- LINE B Summary Cards -->
                    <div class="line-summary-cards line-b">
                        <div class="summary-card process-stop">
                            <div class="summary-card-title">Process Stop</div>
                            <div class="summary-card-value">@GetProcessStopCount("B")</div>
                            <div class="summary-card-unit">minutes</div>
                        </div>
                        <div class="summary-card machine-stop">
                            <div class="summary-card-title">Machine Stop</div>
                            <div class="summary-card-value">@GetMachineStopCount("B")</div>
                            <div class="summary-card-unit">minutes</div>
                        </div>
                    </div>
                    
                    <!-- Logo & Legend Bottom Left -->
                    <div class="production-footer-left">
                        <img src="images/sharp-pe-logo.svg" alt="SHARP Logo" class="production-logo" />
                        <div class="production-legend">
                            <div class="legend-item">
                                <div class="legend-dot normal"></div>
                                <span>Normal Condition</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-dot error"></div>
                                <span>Trouble Condition</span>
                            </div>
                        </div>
                    </div>
                </div>
        </div>
        
    </div>
</div>

@code {
    private List<ErrorLog>? logs;
    private System.Threading.Timer? timer;
    private string currentShift = "S1";
    private int currentPage = 0;
    
    private List<string> processStopNames = new List<string>
    {
        "Base to Tub Stop",
        "Flange Screw Stop",
        "Wiring Stop",
        "Visual Instructional Stop",
        "FA Stop",
        "Feed Water Stop",
        "Inspection Room Stop",
        "Back Cover Stop",
        "Waranty Stop",
        "Bottom Pad Stop",
        "Packing Stop",
        "Finish Packing Stop"
    };
    
    private List<string> machineStopNames = new List<string>
    {
        "Auto Bellow Error",
        "Turn Machine Error",
        "Half Transfer Error",
        "Auto Water Error",
        "I/W Test Error",
        "Washing Perform Test Error",
        "Dehydration Test Error",
        "Transfer Packing Error",
        "Auto Folding Error",
        "Straping #1 Error",
        "Straping #2 Error",
        "Lifter Error"
    };
    
    private List<string> mesinNames = new List<string>
    {
        "Auto Bellow Error",
        "Base to Tub Stop",
        "Turn Machine Error",
        "Flange Screw Stop",
        "Wiring Stop",
        "Half Transfer Error",
        "Visual Instructional Stop",
        "Auto Water Error",
        "I/W Test Error",
        "FA Stop",
        "Washing Perform Test Error",
        "Feed Water Stop",
        "Inspection Room Stop",
        "Dehydration Test Error",
        "Back Cover Stop",
        "Waranty Stop",
        "Transfer Packing Error",
        "Bottom Pad Stop",
        "Packing Stop",
        "Finish Packing Stop",
        "Auto Folding Error",
        "Straping #1 Error",
        "Straping #2 Error",
        "Lifter Error"
    };
    
    private List<string> mesinList => mesinNames.Select(name => $"{currentShift} - {name}").ToList();

    // Carousel Navigation
    private void NextPage()
    {
        if (currentPage < 1) currentPage++;
    }

    private void PreviousPage()
    {
        if (currentPage > 0) currentPage--;
    }

    private void GoToPage(int page)
    {
        currentPage = page;
    }

    // Line A Processes (sama dengan urutan mesinNames)
    private List<string> GetLineAProcesses()
    {
        return mesinNames;
    }

    // Line B Processes (sama dengan urutan mesinNames)
    private List<string> GetLineBProcesses()
    {
        return mesinNames;
    }

    // Posisi indikator untuk Line A (bottom line)
    private (double top, double left) GetLineAPosition(int index)
    {
        // LINE A: Bottom line - dari kiri ke kanan mengikuti conveyor
        // Posisi disesuaikan dengan jalur production line di background image
        double[] leftPositions = new double[] {
            8, 12, 16, 20, 24, 28, 32, 36, 40, 44, 48, 52,
            56, 60, 64, 68, 72, 76, 80, 84, 88, 92, 94, 96
        };
        
        double[] topPositions = new double[] {
            70, 68, 70, 68, 70, 68, 70, 68, 70, 68, 70, 68,
            70, 68, 70, 68, 70, 68, 70, 68, 70, 68, 70, 68
        };
        
        if (index < leftPositions.Length)
        {
            return (topPositions[index], leftPositions[index]);
        }
        
        return (70, 5 + (index * 3.8));
    }

    // Posisi indikator untuk Line B (top line)
    private (double top, double left) GetLineBPosition(int index)
    {
        // LINE B: Top line - dari kiri ke kanan mengikuti conveyor
        double[] leftPositions = new double[] {
            8, 12, 16, 20, 24, 28, 32, 36, 40, 44, 48, 52,
            56, 60, 64, 68, 72, 76, 80, 84, 88, 92, 94, 96
        };
        
        double[] topPositions = new double[] {
            22, 20, 22, 20, 22, 20, 22, 20, 22, 20, 22, 20,
            22, 20, 22, 20, 22, 20, 22, 20, 22, 20, 22, 20
        };
        
        if (index < leftPositions.Length)
        {
            return (topPositions[index], leftPositions[index]);
        }
        
        return (20, 5 + (index * 3.8));
    }

    // Check if process has error
    private bool IsProcessError(string processName, string line)
    {
        var fullName = $"{currentShift} - {processName}";
        var data = logs?.FirstOrDefault(x => x.nama_mesin_proses == fullName);
        
        if (data == null) return false;
        
        var timeDifference = DateTime.Now - data.waktu;
        var isDataFresh = timeDifference.TotalSeconds <= 5;
        
        return data.data_timer > 0 && isDataFresh;
    }

    // Get timer display for process
    private string GetTimerDisplay(string processName)
    {
        var fullName = $"{currentShift} - {processName}";
        var data = logs?.FirstOrDefault(x => x.nama_mesin_proses == fullName);
        
        if (data == null) return "";
        
        var timeDifference = DateTime.Now - data.waktu;
        var isDataFresh = timeDifference.TotalSeconds <= 5;
        
        if (!isDataFresh) return "";
        
        return $"{FormatTimerShort(data.data_timer)} - {processName}";
    }

    // Get Process Stop count (in minutes)
    private int GetProcessStopCount(string line)
    {
        if (logs == null) return 0;
        
        int totalSeconds = 0;
        foreach (var process in processStopNames)
        {
            var fullName = $"{currentShift} - {process}";
            var data = logs.FirstOrDefault(x => x.nama_mesin_proses == fullName);
            
            if (data != null)
            {
                var timeDifference = DateTime.Now - data.waktu;
                var isDataFresh = timeDifference.TotalSeconds <= 5;
                
                if (isDataFresh && data.data_timer > 0)
                {
                    totalSeconds += data.data_timer;
                }
            }
        }
        
        return totalSeconds / 60; // Convert to minutes
    }

    // Get Machine Stop count (in minutes)
    private int GetMachineStopCount(string line)
    {
        if (logs == null) return 0;
        
        int totalSeconds = 0;
        foreach (var process in machineStopNames)
        {
            var fullName = $"{currentShift} - {process}";
            var data = logs.FirstOrDefault(x => x.nama_mesin_proses == fullName);
            
            if (data != null)
            {
                var timeDifference = DateTime.Now - data.waktu;
                var isDataFresh = timeDifference.TotalSeconds <= 5;
                
                if (isDataFresh && data.data_timer > 0)
                {
                    totalSeconds += data.data_timer;
                }
            }
        }
        
        return totalSeconds / 60; // Convert to minutes
    }

    protected override void OnInitialized()
    {
        LoadData();

        timer = new System.Threading.Timer(async _ =>
        {
            LoadData();
            await InvokeAsync(StateHasChanged);
        }, null, 0, 1000); 
    }

    private void LoadData()
    {
        logs = ServiceKita.GetLatestLogs();
        
        if (logs != null && logs.Any())
        {
            var firstLog = logs.FirstOrDefault();
            if (firstLog != null && !string.IsNullOrEmpty(firstLog.nama_mesin_proses))
            {
                var parts = firstLog.nama_mesin_proses.Split('-');
                if (parts.Length > 0)
                {
                    var shiftPart = parts[0].Trim();
                    if (shiftPart.StartsWith("S") && (shiftPart == "S1" || shiftPart == "S2" || shiftPart == "S3"))
                    {
                        currentShift = shiftPart;
                    }
                }
            }
        }
        
        // ATAU deteksi shift berdasarkan jam
        // currentShift = GetShiftByTime();
    }
    
    // Method untuk deteksi shift berdasarkan jam
    private string GetShiftByTime()
    {
        var now = DateTime.Now;
        var hour = now.Hour;
        var minute = now.Minute;
        
        
        if ((hour == 7 && minute >= 56) || (hour > 7 && hour < 17) || (hour == 17 && minute == 0))
        {
            return "S1";
        }
        else if ((hour == 17 && minute >= 1) || (hour > 17 && hour <= 23) || (hour == 0 && minute <= 25))
        {
            return "S2";
        }
        else
        {
            return "S3";
        }
    }
    
    
    private string FormatTimerShort(int seconds)
    {
        if (seconds >= 3600) 
        {
            int hours = seconds / 3600;
            int minutes = (seconds % 3600) / 60;
            return $"{hours}h {minutes}m";
        }
        else if (seconds >= 60)
        {
            int minutes = seconds / 60;
            int secs = seconds % 60;
            return $"{minutes}m {secs}s";
        }
        else 
        {
            return $"{seconds}s";
        }
    }
    
    private string FormatTimer(int seconds)
    {
        if (seconds >= 3600) 
        {
            int hours = seconds / 3600;
            int minutes = (seconds % 3600) / 60;
            int secs = seconds % 60;
            
            if (minutes > 0 && secs > 0)
                return $"{hours}h {minutes}m {secs}s";
            else if (minutes > 0)
                return $"{hours}h {minutes}m";
            else
                return $"{hours}h";
        }
        else if (seconds >= 60)
        {
            int minutes = seconds / 60;
            int secs = seconds % 60;
            
            if (secs > 0)
                return $"{minutes}m {secs}s";
            else
                return $"{minutes}m";
        }
        else 
        {
            return $"{seconds}s";
        }
    }

    public void Dispose()
    {
        timer?.Dispose();
    }
}