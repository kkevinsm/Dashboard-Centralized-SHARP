@page "/table"
@rendermode InteractiveServer
@using CentralizedDashboard.Models
@using CentralizedDashboard.Services
@inject MesinService ServiceKita
@inject ShiftConfigurationService ShiftService
@inject ShiftAccumulationService AccumulationService

<style>
    /* Sesuaikan di sini */
    .table-minimal th {
        font-size: 22px;       /* ukuran header (DATE / SHIFT) */
        font-weight: 700;
        letter-spacing: 0.6px;
        padding: 20px 12px;    /* vertical / horizontal padding */
        color: #000;
    }
    .table-minimal td {
        font-size: 20px;       /* ukuran isi tabel (angka "Mins") */
        font-weight: 400;      /* pastikan tidak bold */
        padding: 18px 12px;
        vertical-align: middle;
    }
    /* Posisi kolom DATE agar sejajar dengan label modal */
    .table-minimal td:first-child,
    .table-minimal th:first-child {
        text-align: left;
        padding-left: 28px;    /* sesuaikan offset kiri untuk alignment */
        vertical-align: middle;
    }
    .table-minimal .btn-sm {
        font-size: 15px;
        padding: 8px 12px;
        font-weight: 800;
        border-radius: 10px;
    }
    @@media (max-width: 576px) {
        .table-minimal th { font-size: 18px; }
        .table-minimal td { font-size: 16px; padding: 12px 8px; }
    }
</style>

<div class="container-fluid mt-3">
    <div class="mb-3 d-flex justify-content-between align-items-center">
        <div>
            <h1 class="text-primary fw-bold" style="font-size: 2.5rem;">TABLE SUMMARY</h1>
            <p class="text-muted mb-0" style="font-size: 1.3rem;">CENTRALIZE MONITORING SYSTEM</p>
        </div>
    </div>

    <div class="card shadow-sm mb-3 border-0 bg-light">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-1 ms-3 me-5">
                    <label class="form-label fw-bold">Line:</label>
                    <select class="form-select" @bind="selectedLine">
                        <option value="Line A">Line A</option>
                        <option value="Line B">Line B</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">From Date:</label>
                    <input type="date" class="form-control" @bind="startDate" max="@DateTime.Now.ToString("yyyy-MM-dd")" @bind:event="onchange" />
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">To Date:</label>
                    <input type="date" class="form-control" @bind="endDate" max="@DateTime.Now.ToString("yyyy-MM-dd")" @bind:event="onchange" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">Show:</label>
                    <select class="form-select" @onchange="ChangePageSize">
                        <option value="7">7 Days</option>
                        <option value="14">14 Days</option>
                        <option value="30">30 Days</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w- fw-bold" @onclick="ApplyFilter">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-minimal mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">DATE</th>
                            <th scope="col">SHIFT 1</th>
                            <th scope="col">SHIFT 2</th>
                            <th scope="col">SHIFT 3</th>
                            <th scope="col" class="text-center">MACHINE</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in tableData)
                        {
                            <tr>
                                <td class="text-dark">@item.Date</td>
                                <td class="text-primary">@item.Shift1</td>
                                <td class="text-primary">@item.Shift2</td>
                                <td class="text-primary">@item.Shift3</td>
                                <td class="text-center">
                                    <button class="btn btn-outline-primary btn-sm" @onclick="() => ShowDetail(item)">DETAIL</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        @* UI Kontrol Pagination *@
        <div class="card-footer bg-white py-3">
            <div class="d-flex justify-content-center align-items-center">
                <nav aria-label="Page navigation">
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item @(currentPage == 0 ? "disabled" : "")">
                            <a class="page-link" @onclick="() => GoToPage(0)" style="cursor:pointer">First</a>
                        </li>

                        @* Logika Windowing Angka *@
                        @{
                            int startPage = Math.Max(0, currentPage - 2);
                            int endPage = Math.Min(totalPages - 1, startPage + 4);
                            if (endPage - startPage < 4) startPage = Math.Max(0, endPage - 4);
                        }

                        @for (int i = startPage; i <= endPage; i++)
                        {
                            int pageNumber = i;
                            <li class="page-item @(currentPage == pageNumber ? "active" : "")">
                                <a class="page-link" @onclick="() => GoToPage(pageNumber)" style="cursor:pointer">
                                    @(pageNumber + 1)
                                </a>
                            </li>
                        }

                        <li class="page-item @(currentPage >= totalPages - 1 ? "disabled" : "")">
                            <a class="page-link" @onclick="() => GoToPage(totalPages - 1)" style="cursor:pointer">Last</a>
                        </li>
                    </ul>
                </nav>
            </div>
            <div class="text-center mt-2">
                <small class="text-muted">Halaman @(currentPage + 1) dari @totalPages</small>
            </div>
        </div>
    </div>
</div>

    @if (showDetailModal)
    {
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.4);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detail Informasi</h5>
                    <button type="button" class="btn-close" aria-label="close" @onclick="CloseDetail"></button>
                </div>
                <div class="modal-body">
                    @if (selectedItem != null)
                    {
                        <p><strong>Tanggal:</strong> @selectedItem.Date</p>
                        <p><strong>Shift 1:</strong> @selectedItem.Shift1</p>
                        <p><strong>Shift 2:</strong> @selectedItem.Shift2</p>
                        <p><strong>Shift 3:</strong> @selectedItem.Shift3</p>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary btn-sm" @onclick="CloseDetail">Close</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Logo SHARP di pojok kanan bawah -->
<div style="margin-top: 80px; margin-bottom: 16px; pointer-events: none;">
    <img src="images/sharp-pe-logo.svg" alt="SHARP Logo" style="width:220px; height:auto; pointer-events: auto;" />
</div>

@code { 
    private List<TableData> tableData = new();
    private DateTime startDate = DateTime.Now.AddDays(-6);
    private DateTime endDate = DateTime.Now;
    private string selectedLine = "Line A";
    
    // Perhitungan total halaman berdasarkan rentang filter
    private int totalPages => Math.Max(1, (int)Math.Ceiling(((endDate.Date - startDate.Date).TotalDays + 1) / pageSize));

// Fungsi untuk berpindah ke halaman spesifik
    private void GoToPage(int pageIndex)
    {
        if (pageIndex >= 0 && pageIndex < totalPages)
        {
            currentPage = pageIndex;
            LoadPaginatedData();
        }
    }
 
    private int currentPage = 0; // 0 berarti mulai dari hari ini
    private int pageSize = 7;    // Default 7 hari per halaman
    private List<ErrorLog>? logs = null;
    private List<ShiftConfiguration>? shiftConfigs = null;
    private bool showDetailModal = false;
    private TableData? selectedItem = null;
    
    private List<string> processStopNames = new List<string>
    {
        "Base to Tub Stop",
        "Flange Screw Stop",
        "Wiring Stop",
        "Visual Instructional Stop",
        "FA Stop",
        "Feed Water Stop",
        "Inspection Room Stop",
        "Back Cover Stop",
        "Waranty Stop",
        "Bottom Pad Stop",
        "Packing Stop",
        "Finish Packing Stop"
    };

    private List<string> machineStopNames = new List<string>
    {
       "Auto Bellow Error",
        "Turn Machine Error",
        "Half Transfer Error",
        "Auto Water Error",
        "I/W Test Error",
        "Washing Perform Test Error",
        "Dehydration Test Error",
        "Transfer Packing Error",
        "Auto Folding Error",
        "Straping #1 Error",
        "Straping #2 Error",
        "Lifter Error"
    };

    private async Task ApplyFilter()
    {
        currentPage = 0; // Reset ke hal 1 saat filter berubah
        await Task.Run(() => LoadPaginatedData());
    }


    protected override async Task OnInitializedAsync()
    {
        AccumulationService.InitializeTable();
        logs = ServiceKita.GetLatestLogs();
        shiftConfigs = ShiftService.GetAllShifts();
        
        LoadPaginatedData(); // Ganti GenerateLast7Days dengan ini
        
        // Background task (modifikasi agar tidak reset ke hari pertama saat update)
        _ = Task.Run(async () =>
        {
            while (true)
            {
                await Task.Delay(5000);
                await InvokeAsync(async () =>
                {
                    logs = ServiceKita.GetLatestLogs();
                    UpdateAccumulationIfNeeded();
                    LoadPaginatedData(); // Refresh data halaman yang sedang dibuka
                    StateHasChanged();
                });
            }
        });
    }

    private void LoadPaginatedData()
    {
        tableData = new List<TableData>();
        
        // Menghitung berapa hari yang dilewati berdasarkan halaman
        int startOffset = currentPage * pageSize;
        
        for (int i = 0; i < pageSize; i++)
        {
            // Mundur dari endDate berdasarkan offset halaman
            DateTime targetDate = endDate.Date.AddDays(-(startOffset + i));

            // Validasi: Tidak boleh melebihi hari ini (mencegah bug masa depan)
            if (targetDate.Date > DateTime.Now.Date) continue;

            // Validasi: Tidak boleh kurang dari tanggal filter 'From Date'
            if (targetDate.Date < startDate.Date) break;

            string dateStr = targetDate.ToString("dddd dd/MM/yyyy", System.Globalization.CultureInfo.GetCultureInfo("id-ID"));
            
            var shift1Total = GetShiftAccumulationAndSave(targetDate, 1);
            var shift2Total = GetShiftAccumulationAndSave(targetDate, 2);
            var shift3Total = GetShiftAccumulationAndSave(targetDate, 3);
            
            tableData.Add(new TableData 
            { 
                Date = dateStr.ToUpper(),
                Shift1 = FormatTimer(shift1Total),
                Shift2 = FormatTimer(shift2Total),
                Shift3 = FormatTimer(shift3Total)
            });
        }
    }

    // Fungsi Navigasi
    private void NextPage()
    {
        // Cek apakah hari berikutnya masih dalam rentang startDate
        DateTime nextStartDay = endDate.AddDays(-((currentPage + 1) * pageSize));
        if (nextStartDay.Date >= startDate.Date)
        {
            currentPage++;
            LoadPaginatedData();
        }
    }

    private void PreviousPage()
    {
        if (currentPage > 0)
        {
            currentPage--;
            LoadPaginatedData();
        }
    }

    private void ChangePageSize(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int newSize))
        {
            pageSize = newSize;
            currentPage = 0; 
            LoadPaginatedData();
        }
    }

    private int GetShiftAccumulationAndSave(DateTime date, int shift)
    {
    // 1. PROTEKSI: Jangan simpan jika tanggal lebih dari hari ini
    // Ini untuk mencegah bug tanggal 25-31 Januari muncul kembali
    if (date.Date > DateTime.Now.Date) 
        {
        return 0; 
        }

    // 2. Gunakan 'var' untuk menghindari error tipe data jika Model berubah
    var stored = AccumulationService.GetAccumulation(date, shift);
    
    // Pastikan fungsi ini ada dan tidak error
    int latestTotal = CalculateShiftAccumulation(date, shift);
    
    if (stored == null)
        {
        AccumulationService.SaveAccumulation(date, shift, latestTotal);
        }
    else
        {
        // Hitung selisih (delta)
        int delta = latestTotal - stored.TotalSeconds;
        if (delta > 0)
        {
            AccumulationService.SaveAccumulation(date, shift, delta);
        }
    }
    
    // Ambil data terbaru setelah di-update
    var updatedRecord = AccumulationService.GetAccumulation(date, shift);
    return updatedRecord?.TotalSeconds ?? 0;
}   
    private void UpdateAccumulationIfNeeded()
    {
        // Update akumulasi hanya untuk hari ini (untuk catch data terbaru)
        DateTime today = DateTime.Now.Date;
        
        for (int shift = 1; shift <= 3; shift++)
        {
            // Ambil data yang sudah ada di database
            var stored = AccumulationService.GetAccumulation(today, shift);
            
            // Hitung akumulasi terbaru dari logs
            int latestTotal = CalculateShiftAccumulation(today, shift);
            
            // Jika belum ada record, save langsung
            if (stored == null)
            {
                AccumulationService.SaveAccumulation(today, shift, latestTotal);
            }
            else
            {
                // Hanya save DELTA (selisih) untuk avoid double-count
                int delta = latestTotal - stored.TotalSeconds;
                if (delta > 0)
                {
                    AccumulationService.SaveAccumulation(today, shift, delta);
                }
            }
        }
    }

    private int CalculateShiftAccumulation(DateTime date, int shift)
    {
        if (logs == null || shiftConfigs == null) return 0;
        
        // Ambil konfigurasi shift dari database
        var shiftConfig = shiftConfigs.FirstOrDefault(s => s.ShiftName == $"Shift {shift}");
        if (shiftConfig == null) return 0;
        
        // Tentukan jam awal dan akhir untuk setiap shift berdasarkan konfigurasi
        DateTime shiftStart, shiftEnd;
        
        // Konversi TimeOnly ke waktu pada tanggal yang ditentukan
        shiftStart = date.Date.Add(shiftConfig.StartTime.ToTimeSpan());
        shiftEnd = date.Date.Add(shiftConfig.EndTime.ToTimeSpan());
        
        // Jika end time lebih kecil dari start time, berarti shift melewat
        //i tengah malam
        if (shiftEnd <= shiftStart)
        {
            shiftEnd = shiftEnd.AddDays(1);
        }

        // Hitung shift berdasarkan waktu
        string shiftLabel = $"S{shift}";
        
        // Akumulasi semua timer data (Process Stop + Machine Stop) dalam range shift tersebut
        int totalSeconds = 0;
        var allMachines = new List<string>(processStopNames);
        allMachines.AddRange(machineStopNames);
        
        foreach (var machine in allMachines)
        {
            // Tambahkan selectedLine ke kriteria pencarian jika kolom database Anda mendukung
            // Atau filter logs berdasarkan properti Line jika ada di model ErrorLog
            var fullName = $"S{shift} - {machine}";
            
            var logsInRange = logs
                .Where(log => log.nama_mesin_proses == fullName && 
                              log.waktu >= shiftStart && 
                              log.waktu < shiftEnd)
                              
                .ToList();
            
            totalSeconds += logsInRange.Sum(log => log.data_timer);
        }
        
        return totalSeconds;
    }


    private string FormatTimer(int seconds)
    {
        if (seconds >= 3600) 
        {
            int hours = seconds / 3600;
            int minutes = (seconds % 3600) / 60;
            int secs = seconds % 60;
            
            if (minutes > 0 && secs > 0)
                return $"{hours}h {minutes}m {secs}s";
            else if (minutes > 0)
                return $"{hours}h {minutes}m";
            else
                return $"{hours}h";
        }
        else if (seconds >= 60)
        {
            int minutes = seconds / 60;
            int secs = seconds % 60;
            
            if (secs > 0)
                return $"{minutes}m {secs}s";
            else
                return $"{minutes}m";
        }
        else 
        {
            return $"{seconds}s";
        }
    }
                
    private void ShowDetail(TableData item)
    {
        selectedItem = item;
        showDetailModal = true;
    }

    private void CloseDetail()
    {
        showDetailModal = false;
        selectedItem = null;
    }

    public class TableData
    {
        public string Date { get; set; } = "";
        public string Shift1 { get; set; } = "";
        public string Shift2 { get; set; } = "";
        public string Shift3 { get; set; } = "";
    }
}


