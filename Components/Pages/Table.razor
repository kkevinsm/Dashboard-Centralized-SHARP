@page "/table"
@rendermode InteractiveServer
@using CentralizedDashboard.Models
@using CentralizedDashboard.Services
@inject MesinService ServiceKita
@inject ShiftConfigurationService ShiftService
@inject ShiftAccumulationService AccumulationService

<style>
    /* Sesuaikan di sini */
    .table-minimal th {
        font-size: 22px;       /* ukuran header (DATE / SHIFT) */
        font-weight: 700;
        letter-spacing: 0.6px;
        padding: 20px 12px;    /* vertical / horizontal padding */
        color: #000;
    }
    .table-minimal td {
        font-size: 20px;       /* ukuran isi tabel (angka "Mins") */
        font-weight: 400;      /* pastikan tidak bold */
        padding: 18px 12px;
        vertical-align: middle;
    }
    /* Posisi kolom DATE agar sejajar dengan label modal */
    .table-minimal td:first-child,
    .table-minimal th:first-child {
        text-align: left;
        padding-left: 28px;    /* sesuaikan offset kiri untuk alignment */
        vertical-align: middle;
    }
    .table-minimal .btn-sm {
        font-size: 15px;
        padding: 8px 12px;
        font-weight: 800;
        border-radius: 10px;
    }
    @@media (max-width: 576px) {
        .table-minimal th { font-size: 18px; }
        .table-minimal td { font-size: 16px; padding: 12px 8px; }
    }
</style>

<div class="container-fluid mt-3">
    <div class="mb-3">
        <h1 class="text-primary fw-bold" style="font-size: 2.5rem;">TABLE SUMMARY</h1>
         <p class="text-muted mb-0" style="font-size: 1.5rem;">CENTRALIZE MONITORING SYSTEM</p>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-minimal mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">DATE</th>
                            <th scope="col">SHIFT 1</th>
                            <th scope="col">SHIFT 2</th>
                            <th scope="col">SHIFT 3</th>
                            <th scope="col" class="text-center">MACHINE</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in tableData)
                        {
                            <tr>
                                <td class="text-dark">@item.Date</td>
                                <td class="text-primary">@item.Shift1</td>
                                <td class="text-primary">@item.Shift2</td>
                                <td class="text-primary">@item.Shift3</td>
                                <td class="text-center">
                                    <button class="btn btn-outline-primary btn-sm" @onclick="() => ShowDetail(item)">DETAIL</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@if (showDetailModal)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.4);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detail Informasi</h5>
                    <button type="button" class="btn-close" aria-label="close" @onclick="CloseDetail"></button>
                </div>
                <div class="modal-body">
                    @if (selectedItem != null)
                    {
                        <p><strong>Tanggal:</strong> @selectedItem.Date</p>
                        <p><strong>Shift 1:</strong> @selectedItem.Shift1</p>
                        <p><strong>Shift 2:</strong> @selectedItem.Shift2</p>
                        <p><strong>Shift 3:</strong> @selectedItem.Shift3</p>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary btn-sm" @onclick="CloseDetail">Close</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Logo SHARP di pojok kanan bawah -->
<div style="margin-top: 32px; margin-bottom: 16px; pointer-events: none;">
    <img src="images/sharp-pe-logo.svg" alt="SHARP Logo" style="width:220px; height:auto; pointer-events: auto;" />
</div>

@code {
    private List<TableData> tableData = new();
    private List<ErrorLog>? logs = null;
    private List<ShiftConfiguration>? shiftConfigs = null;
    private bool showDetailModal = false;
    private TableData? selectedItem = null;
    
    private List<string> processStopNames = new List<string>
    {
        "Base to Tub Stop",
        "Flange Screw Stop",
        "Wiring Stop",
        "Visual Instructional Stop",
        "FA Stop",
        "Feed Water Stop",
        "Inspection Room Stop",
        "Back Cover Stop",
        "Waranty Stop",
        "Bottom Pad Stop",
        "Packing Stop",
        "Finish Packing Stop"
    };

    private List<string> machineStopNames = new List<string>
    {
       "Auto Bellow Error",
        "Turn Machine Error",
        "Half Transfer Error",
        "Auto Water Error",
        "I/W Test Error",
        "Washing Perform Test Error",
        "Dehydration Test Error",
        "Transfer Packing Error",
        "Auto Folding Error",
        "Straping #1 Error",
        "Straping #2 Error",
        "Lifter Error"
    };

    protected override async Task OnInitializedAsync()
    {
        // Initialize tabel shift_accumulation jika belum ada
        AccumulationService.InitializeTable();
        
        // Load data dari database
        logs = ServiceKita.GetLatestLogs();
        
        // Load shift configuration dari database
        shiftConfigs = ShiftService.GetAllShifts();
        
        // Generate 7 hari ke belakang dengan load dari cache dan update jika ada data baru
        GenerateLast7Days();
        
        // Start background task untuk check data baru dan update
        _ = Task.Run(async () =>
        {
            while (true)
            {
                await Task.Delay(5000); // Check setiap 5 detik
                await InvokeAsync(async () =>
                {
                    // Reload logs terbaru
                    logs = ServiceKita.GetLatestLogs();
                    
                    // Update akumulasi jika ada data baru
                    UpdateAccumulationIfNeeded();
                    
                    StateHasChanged();
                });
            }
        });
    }

    private void GenerateLast7Days()
    {
        tableData = new List<TableData>();
        
        // Ambil 7 hari terakhir (dari hari ini hingga 6 hari ke belakang)
        for (int i = 0; i <= 6; i++)
        {
            DateTime date = DateTime.Now.AddDays(-i);
            string dateStr = date.ToString("dddd dd/MM/yyyy", System.Globalization.CultureInfo.GetCultureInfo("id-ID"));
            
            // Hitung akumulasi per shift dan simpan/update ke database
            var shift1Total = GetShiftAccumulationAndSave(date, 1);
            var shift2Total = GetShiftAccumulationAndSave(date, 2);
            var shift3Total = GetShiftAccumulationAndSave(date, 3);
            
            tableData.Add(new TableData 
            { 
                Date = dateStr.ToUpper(),
                Shift1 = FormatTimer(shift1Total),
                Shift2 = FormatTimer(shift2Total),
                Shift3 = FormatTimer(shift3Total)
            });
        }
    }

    private int GetShiftAccumulationAndSave(DateTime date, int shift)
    {
        // Ambil data yang sudah tersimpan sebelumnya
        var stored = AccumulationService.GetAccumulation(date, shift);
        
        // Hitung akumulasi terbaru dari logs
        int latestTotal = CalculateShiftAccumulation(date, shift);
        
        // Jika belum ada record, save langsung
        if (stored == null)
        {
            AccumulationService.SaveAccumulation(date, shift, latestTotal);
        }
        else
        {
            // Jika sudah ada, hanya save DELTA (selisih)
            // Supaya tidak double-count
            int delta = latestTotal - stored.TotalSeconds;
            if (delta > 0)
            {
                AccumulationService.SaveAccumulation(date, shift, delta);
            }
        }
        
        // Return total terbaru dari database
        var updatedRecord = AccumulationService.GetAccumulation(date, shift);
        return updatedRecord?.TotalSeconds ?? 0;
    }

    private void UpdateAccumulationIfNeeded()
    {
        // Update akumulasi hanya untuk hari ini (untuk catch data terbaru)
        DateTime today = DateTime.Now.Date;
        
        for (int shift = 1; shift <= 3; shift++)
        {
            // Ambil data yang sudah ada di database
            var stored = AccumulationService.GetAccumulation(today, shift);
            
            // Hitung akumulasi terbaru dari logs
            int latestTotal = CalculateShiftAccumulation(today, shift);
            
            // Jika belum ada record, save langsung
            if (stored == null)
            {
                AccumulationService.SaveAccumulation(today, shift, latestTotal);
            }
            else
            {
                // Hanya save DELTA (selisih) untuk avoid double-count
                int delta = latestTotal - stored.TotalSeconds;
                if (delta > 0)
                {
                    AccumulationService.SaveAccumulation(today, shift, delta);
                }
            }
        }
    }

    private int CalculateShiftAccumulation(DateTime date, int shift)
    {
        if (logs == null || shiftConfigs == null) return 0;
        
        // Ambil konfigurasi shift dari database
        var shiftConfig = shiftConfigs.FirstOrDefault(s => s.ShiftName == $"Shift {shift}");
        if (shiftConfig == null) return 0;
        
        // Tentukan jam awal dan akhir untuk setiap shift berdasarkan konfigurasi
        DateTime shiftStart, shiftEnd;
        
        // Konversi TimeOnly ke waktu pada tanggal yang ditentukan
        shiftStart = date.Date.Add(shiftConfig.StartTime.ToTimeSpan());
        shiftEnd = date.Date.Add(shiftConfig.EndTime.ToTimeSpan());
        
        // Jika end time lebih kecil dari start time, berarti shift melewat
        //i tengah malam
        if (shiftEnd <= shiftStart)
        {
            shiftEnd = shiftEnd.AddDays(1);
        }

        // Hitung shift berdasarkan waktu
        string shiftLabel = $"S{shift}";
        
        // Akumulasi semua timer data (Process Stop + Machine Stop) dalam range shift tersebut
        int totalSeconds = 0;
        
        // Combine semua nama mesin (process stop + machine stop)
        var allMachines = new List<string>(processStopNames);
        allMachines.AddRange(machineStopNames);
        
        foreach (var machine in allMachines)
        {
            var fullName = $"{shiftLabel} - {machine}";
            var logsInRange = logs
                .Where(log => log.nama_mesin_proses == fullName && 
                             log.waktu >= shiftStart && 
                             log.waktu < shiftEnd)
                .ToList();
            
            totalSeconds += logsInRange.Sum(log => log.data_timer);
        }
        
        return totalSeconds;
    }

    private string FormatTimer(int seconds)
    {
        if (seconds >= 3600) 
        {
            int hours = seconds / 3600;
            int minutes = (seconds % 3600) / 60;
            int secs = seconds % 60;
            
            if (minutes > 0 && secs > 0)
                return $"{hours}h {minutes}m {secs}s";
            else if (minutes > 0)
                return $"{hours}h {minutes}m";
            else
                return $"{hours}h";
        }
        else if (seconds >= 60)
        {
            int minutes = seconds / 60;
            int secs = seconds % 60;
            
            if (secs > 0)
                return $"{minutes}m {secs}s";
            else
                return $"{minutes}m";
        }
        else 
        {
            return $"{seconds}s";
        }
    }
                
    private void ShowDetail(TableData item)
    {
        selectedItem = item;
        showDetailModal = true;
    }

    private void CloseDetail()
    {
        showDetailModal = false;
        selectedItem = null;
    }

    public class TableData
    {
        public string Date { get; set; } = "";
        public string Shift1 { get; set; } = "";
        public string Shift2 { get; set; } = "";
        public string Shift3 { get; set; } = "";
    }
}

